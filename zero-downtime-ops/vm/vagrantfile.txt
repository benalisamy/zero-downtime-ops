Vagrant.configure("2") do |config|

  config.vm.box = "generic/debian12"

  config.vm.provider :libvirt do |v|
    v.memory = 4096
    v.cpus = 2
  end

  config.vm.provider :virtualbox do |v|
    v.memory = 4096
    v.cpus = 2
  end

  COMMON_INIT = <<-SHELL
    apt update -y

    # DÃ©sactiver SWAP (obligatoire pour Kubernetes)
    sed -i '/swap/d' /etc/fstab
    swapoff -a

    modprobe overlay
    modprobe br_netfilter

    cat <<EOF >/etc/sysctl.d/k8s.conf
    net.bridge.bridge-nf-call-iptables  = 1
    net.bridge.bridge-nf-call-ip6tables = 1
    net.ipv4.ip_forward = 1
    EOF

    sysctl --system

    mkdir -p /home/vagrant/.ssh
    cp /tmp/id_rsa.pub /home/vagrant/.ssh/authorized_keys
    chown -R vagrant:vagrant /home/vagrant/.ssh
    chmod 600 /home/vagrant/.ssh/authorized_keys
  SHELL

  config.vm.define "master1" do |vm|
    vm.vm.hostname = "master1"
    vm.vm.network "private_network", ip: "192.168.121.10"

    vm.vm.provision "file", source: "~/.ssh/id_rsa.pub", destination: "/tmp/id_rsa.pub"
    vm.vm.provision "shell", inline: COMMON_INIT
  end

  config.vm.define "worker1" do |vm|
    vm.vm.hostname = "worker1"
    vm.vm.network "private_network", ip: "192.168.121.11"

    vm.vm.provision "file", source: "~/.ssh/id_rsa.pub", destination: "/tmp/id_rsa.pub"
    vm.vm.provision "shell", inline: COMMON_INIT
  end

  config.vm.define "worker2" do |vm|
    vm.vm.hostname = "worker2"
    vm.vm.network "private_network", ip: "192.168.121.12"

    vm.vm.provision "file", source: "~/.ssh/id_rsa.pub", destination: "/tmp/id_rsa.pub"
    vm.vm.provision "shell", inline: COMMON_INIT
  end

end
