---
- name: Uncordonner le nœud (replanifiable)
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    kind: Node
    name: "{{ inventory_hostname }}"
    state: present
    definition:
      spec:
        unschedulable: false

- name: Vérifier l'état du nœud dans le cluster
  command: "kubectl --kubeconfig {{ kubeconfig_path }} get node {{ inventory_hostname }}"
  register: node_status
  changed_when: false

- name: Afficher l'état du nœud
  debug:
    msg: "{{ node_status.stdout_lines }}"

- name: Récupérer les pods de l'app de paiement
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig_path }}"
    kind: Pod
    namespace: "{{ k8s_namespace }}"
    label_selectors:
      - "app={{ k8s_app_label }}"
  register: payment_pods

- name: Afficher la répartition des pods sur les nœuds
  debug:
    msg: >-
      Pods de {{ k8s_app_label }} après update sur {{ inventory_hostname }} :
      {{ payment_pods.resources | map(attribute='metadata.name') | list }}
      -> nodes: {{ payment_pods.resources | map(attribute='spec.nodeName') | list }}
